# Unity Headless ì„œë²„ í”„ë¡œíŒŒì¼ë§ ì‚¬ìš©ë²•

## ðŸš€ ë¹ ë¥¸ ì‹œìž‘

### 1ë‹¨ê³„: ì”¬ì— í”„ë¡œíŒŒì¼ëŸ¬ ì¶”ê°€

1. GameScene ì—´ê¸°
2. Hierarchyì—ì„œ ë¹ˆ GameObject ìƒì„±
3. ì´ë¦„: `ServerProfiler`
4. `ServerProfilerManager` ì»´í¬ë„ŒíŠ¸ ì¶”ê°€
5. Inspector ì„¤ì •:
   - Enable On Server Only: âœ…
   - Is Enabled: âœ…
   - Log Interval: `5` (5ì´ˆë§ˆë‹¤)

### 2ë‹¨ê³„: ì¸¡ì •í•  ì½”ë“œì— ì¶”ê°€

```csharp
// ì¸¡ì • ì‹œìž‘
ServerPerformanceProfiler.Start("í•¨ìˆ˜ì´ë¦„");

// ì¸¡ì •í•  ì½”ë“œ
DoSomething();

// ì¸¡ì • ì¢…ë£Œ
ServerPerformanceProfiler.End("í•¨ìˆ˜ì´ë¦„");
```

### 3ë‹¨ê³„: Headless ì„œë²„ ì‹¤í–‰

```bash
# ì„œë²„ ë¹Œë“œ í›„ ì‹¤í–‰
Server.exe -logFile server.log
```

## ðŸ“ ì‚¬ìš© ì˜ˆì œ

### PlayerController.cs

```csharp
protected virtual void FixedUpdate()
{
    if (!IsServer) return;
    if (netIsDeath.Value) return;

    // ì „ì²´ FixedUpdate ì¸¡ì •
    ServerPerformanceProfiler.Start("PlayerController.FixedUpdate");

    // ì´ë™ ì¸¡ì •
    if (netMoveDirection.Value.magnitude >= 0.1f)
    {
        ServerPerformanceProfiler.Start("PlayerController.Move");
        PlayerMove();
        ServerPerformanceProfiler.End("PlayerController.Move");
    }

    // ì í”„ ì¸¡ì •
    if (isJumpQueued)
    {
        ServerPerformanceProfiler.Start("PlayerController.Jump");
        PlayerJump();
        ServerPerformanceProfiler.End("PlayerController.Jump");
    }

    // ìž¡ê¸° ì¸¡ì •
    if (isGrabQueued)
    {
        ServerPerformanceProfiler.Start("PlayerController.Grab");
        PlayerGrab();
        ServerPerformanceProfiler.End("PlayerController.Grab");
    }

    // ì• ë‹ˆë©”ì´ì…˜ ë™ê¸°í™” ì¸¡ì •
    ServerPerformanceProfiler.Start("PlayerController.SyncAnimation");
    SyncAnimationState();
    ServerPerformanceProfiler.End("PlayerController.SyncAnimation");

    ServerPerformanceProfiler.End("PlayerController.FixedUpdate");
}
```

### OnCollisionStay ì¸¡ì •

```csharp
private void OnCollisionStay(Collision collision)
{
    if (!IsServer) return;

    ServerPerformanceProfiler.Start("PlayerController.OnCollisionStay");

    foreach (ContactPoint contact in collision.contacts)
    {
        if (contact.normal.y > 0.5f)
        {
            if (netIsDiving.Value)
            {
                OnDiveLand();
            }

            if (rb.linearVelocity.y <= 0.1f)
            {
                if (!netIsGrounded.Value)
                {
                    netIsGrounded.Value = true;
                }
                if (canDive)
                {
                    canDive = false;
                }
            }

            ServerPerformanceProfiler.End("PlayerController.OnCollisionStay");
            return;
        }
    }

    ServerPerformanceProfiler.End("PlayerController.OnCollisionStay");
}
```

### BotController.cs

```csharp
protected override void FixedUpdate()
{
    if (!IsServer) return;

    ServerPerformanceProfiler.Start("BotController.FixedUpdate");

    // AI ì—…ë°ì´íŠ¸ ì¸¡ì •
    ServerPerformanceProfiler.Start("BotController.UpdateAI");
    UpdateBotAI();
    ServerPerformanceProfiler.End("BotController.UpdateAI");

    // ë¶€ëª¨ í´ëž˜ìŠ¤ í˜¸ì¶œ
    base.FixedUpdate();

    ServerPerformanceProfiler.End("BotController.FixedUpdate");
}
```

## ðŸ“Š ë¡œê·¸ ì˜ˆì‹œ

ì½˜ì†”/íŒŒì¼ì— 5ì´ˆë§ˆë‹¤ ì•„ëž˜ì™€ ê°™ì´ ì¶œë ¥ë©ë‹ˆë‹¤:

```
=== Server Performance Report ===
Time: 2025-01-15 14:30:25
Interval: 5ì´ˆ

Name                              Calls    Total(ms)     Avg(ms)     Min(ms)     Max(ms)
---------------------------------------------------------------------------------------------
PlayerController.OnCollisionStay  2500      450.234       0.180       0.050       2.500
PlayerController.FixedUpdate      1250      380.120       0.304       0.100       5.200
BotController.FixedUpdate          500      250.450       0.501       0.200       3.800
PlayerController.Move             1000      150.230       0.150       0.080       1.200
BotController.UpdateAI             100      120.580       1.206       0.500      15.300
PlayerController.Grab              150       45.670       0.304       0.150       2.100
PlayerController.Jump              200       30.450       0.152       0.100       1.800
PlayerController.SyncAnimation    1250       25.340       0.020       0.010       0.150
================================
```

## ðŸ” ë¡œê·¸ ë¶„ì„ ë°©ë²•

### ìµœì í™” ìš°ì„ ìˆœìœ„ íŒë‹¨

1. **Total(ms)ì´ ë†’ì€ ê²ƒ**: ì „ì²´ CPU ì‹œê°„ì„ ê°€ìž¥ ë§Žì´ ì°¨ì§€
   - ì˜ˆ: `OnCollisionStay` 450ms â†’ **ìµœìš°ì„  ìµœì í™” ëŒ€ìƒ**

2. **Avg(ms)ì´ 1ms ì´ìƒ**: ê°œë³„ í˜¸ì¶œì´ ëŠë¦¼
   - ì˜ˆ: `BotController.UpdateAI` í‰ê·  1.2ms â†’ ë¡œì§ ìµœì í™” í•„ìš”

3. **Max(ms)ì´ 10ms ì´ìƒ**: ìŠ¤íŒŒì´í¬ ë°œìƒ
   - ì˜ˆ: `UpdateAI` ìµœëŒ€ 15.3ms â†’ ê²½ë¡œ ê³„ì‚° ë¶„ì‚° í•„ìš”

4. **Callsê°€ ë„ˆë¬´ ë§ŽìŒ**: í˜¸ì¶œ ë¹ˆë„ ì¤„ì´ê¸°
   - ì˜ˆ: `OnCollisionStay` 2500íšŒ â†’ í”„ë ˆìž„ ìŠ¤í‚µ ê³ ë ¤

## ðŸ“‚ ë¡œê·¸ íŒŒì¼ ìœ„ì¹˜

**Windows:**
```
C:\Users\[ì‚¬ìš©ìž]\AppData\LocalLow\[íšŒì‚¬ëª…]\[í”„ë¡œì íŠ¸ëª…]\server_performance.log
```

**Linux:**
```
~/.config/unity3d/[íšŒì‚¬ëª…]/[í”„ë¡œì íŠ¸ëª…]/server_performance.log
```

**ì½˜ì†” ë¡œê·¸:**
```
ì„œë²„ ì‹¤í–‰ì‹œ -logFile ì˜µì…˜ìœ¼ë¡œ ì§€ì •í•œ ê²½ë¡œ
```

## âš™ï¸ ì£¼ìš” ì¸¡ì • ëŒ€ìƒ

### ìš°ì„ ìˆœìœ„ 1 (ë°˜ë“œì‹œ ì¸¡ì •)
- `PlayerController.FixedUpdate()` - ì „ì²´ í”Œë ˆì´ì–´ ë¡œì§
- `PlayerController.OnCollisionStay()` - ì§€ë©´ ê°ì§€ (ë§¤ìš° ë¹ˆë²ˆ)
- `BotController.FixedUpdate()` - ë´‡ AI ë¡œì§
- `GameManager.Update()` - ê²Œìž„ ìƒíƒœ ê´€ë¦¬

### ìš°ì„ ìˆœìœ„ 2 (ì„¸ë¶€ ì¸¡ì •)
- `PlayerMove()` - ì´ë™ ì²˜ë¦¬
- `PlayerJump()` - ì í”„ ì²˜ë¦¬
- `PlayerGrab()` - ìž¡ê¸° ì²˜ë¦¬ (Physics.OverlapSphere í¬í•¨)
- `PlayerHeld()` - ìž¡ì€ ì˜¤ë¸Œì íŠ¸ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
- `SyncAnimationState()` - ì• ë‹ˆë©”ì´ì…˜ ë™ê¸°í™”
- `UpdateBotAI()` - ë´‡ AI ê²½ë¡œ ê³„ì‚°

### ìš°ì„ ìˆœìœ„ 3 (ì„ íƒ)
- RPC í•¨ìˆ˜ë“¤ (`MovePlayerServerRpc`, `JumpPlayerServerRpc` ë“±)
- NetworkVariable ì—…ë°ì´íŠ¸
- ì¶©ëŒ ì´ë²¤íŠ¸ë“¤ (`OnCollisionEnter`, `OnCollisionExit`)

## ðŸ’¡ ì‹¤ì „ íŒ

### 1. ì¸¡ì • ì˜¤ë²„í—¤ë“œ ìµœì†Œí™”

```csharp
// âŒ ë„ˆë¬´ ìž‘ì€ ì½”ë“œ ì¸¡ì • (ì˜¤ë²„í—¤ë“œê°€ ë” í¼)
ServerPerformanceProfiler.Start("TinyFunction");
int x = 1 + 1;
ServerPerformanceProfiler.End("TinyFunction");

// âœ… ì˜ë¯¸ ìžˆëŠ” ë¡œì§ë§Œ ì¸¡ì •
ServerPerformanceProfiler.Start("ComplexCalculation");
for (int i = 0; i < 1000; i++) {
    DoComplexMath();
}
ServerPerformanceProfiler.End("ComplexCalculation");
```

### 2. ì¤‘ì²© ì¸¡ì •

```csharp
ServerPerformanceProfiler.Start("PlayerController.FixedUpdate");

    ServerPerformanceProfiler.Start("PlayerController.Move");
    PlayerMove();
    ServerPerformanceProfiler.End("PlayerController.Move");

ServerPerformanceProfiler.End("PlayerController.FixedUpdate");

// ê²°ê³¼:
// PlayerController.FixedUpdate: 5ms
// PlayerController.Move: 3ms
// â†’ Moveê°€ FixedUpdateì˜ 60%ë¥¼ ì°¨ì§€
```

### 3. ì¡°ê±´ë¶€ ì¸¡ì • (ë¦´ë¦¬ì¦ˆ ë¹Œë“œì—ì„œ ì œê±°)

```csharp
#if UNITY_SERVER || UNITY_EDITOR
    ServerPerformanceProfiler.Start("ExpensiveOperation");
#endif

    DoExpensiveOperation();

#if UNITY_SERVER || UNITY_EDITOR
    ServerPerformanceProfiler.End("ExpensiveOperation");
#endif
```

## ðŸŽ¯ ìµœì í™” ì›Œí¬í”Œë¡œìš°

1. **ë² ì´ìŠ¤ë¼ì¸ ì¸¡ì •**: ìµœì í™” ì „ ì„±ëŠ¥ ê¸°ë¡
2. **ë³‘ëª© ì‹ë³„**: Total(ms) ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
3. **ìµœì í™” ì ìš©**: ê°€ìž¥ ì˜í–¥ í° ë¶€ë¶„ë¶€í„°
4. **íš¨ê³¼ ê²€ì¦**: ì¸¡ì • â†’ ë¹„êµ â†’ ê°œì„ ìœ¨ ê³„ì‚°

ì˜ˆì‹œ:
```
Before: OnCollisionStay - 450ms total (36% CPU)
After:  OnCollisionStay - 150ms total (12% CPU)
ê°œì„ :   300ms ì ˆì•½ (66% ê°ì†Œ)
```

## ðŸ› ï¸ ë¬¸ì œ í•´ê²°

**Q: ë¡œê·¸ê°€ ì•ˆ ë‚˜ì™€ìš”**
- ServerProfilerManagerê°€ ì”¬ì— ìžˆëŠ”ì§€ í™•ì¸
- Is Enabled ì²´í¬ í™•ì¸
- Headless ëª¨ë“œë¡œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸

**Q: ì„±ëŠ¥ì´ ëŠë ¤ì¡Œì–´ìš”**
- Log Intervalì„ 5ì´ˆ â†’ 10ì´ˆë¡œ ì¦ê°€
- ì¸¡ì • í•­ëª© ì¤„ì´ê¸° (í•µì‹¬ë§Œ)
- ë¦´ë¦¬ì¦ˆ ë¹Œë“œì—ì„œëŠ” í”„ë¡œíŒŒì¼ë§ ë¹„í™œì„±í™”

**Q: Start/End ì§ì´ ì•ˆ ë§žì•„ìš”**
- return ì „ì— End() í˜¸ì¶œ í™•ì¸
- try-finally ì‚¬ìš© ê³ ë ¤

```csharp
ServerPerformanceProfiler.Start("Function");
try {
    DoSomething();
    if (condition) return; // âŒ End()ë¥¼ í˜¸ì¶œ ì•ˆ í•¨!
}
finally {
    ServerPerformanceProfiler.End("Function"); // âœ… í•­ìƒ í˜¸ì¶œë¨
}
```

---

**ë‹¤ìŒ ë‹¨ê³„**: PlayerController.csì— í”„ë¡œíŒŒì¼ë§ ì½”ë“œ ì¶”ê°€ â†’ ì„œë²„ ë¹Œë“œ â†’ ë¡œê·¸ ë¶„ì„
